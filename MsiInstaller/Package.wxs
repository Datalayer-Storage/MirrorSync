<?xml version="1.0" encoding="UTF-8"?>

<!--
	This will install the MirrorSync.exe file as a Windows Service
	and use the current user name to set the config file path.
	The service runs as local system but will use that config file

	sc.exe config "Data Layer Mirror Sync Service" binPath="C:\Program Files\<path to>\DlMirrorSync.exe <full path to config file>"
-->

<!-- Define the variables in "$(var.*) expressions" -->
<?define Name = "Data Layer Mirror Sync Service" ?>
<?define Manufacturer = "DataLayer-Storage" ?>
<?define Version = "0.2.0.0" ?>
<?define UpgradeCode = "4E4A92BC-3DA5-4A74-BF8E-D48CFD01010C" ?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
    xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">

    <Package Name="$(Name)" Manufacturer="$(Manufacturer)" Version="$(Version)" UpgradeCode="$(var.UpgradeCode)" Compressed="true">
        <Property Id="HOSTENVVARIABLE" Hidden="no" Secure="yes"/>

        <!-- UI defintion -->
        <WixVariable Id="WixUILicenseRtf" Value="LICENSE.rtf" />
        <ui:WixUI Id="WixUI_InstallDir_EnvVar" InstallDirectory="INSTALLFOLDER" />

        <MediaTemplate EmbedCab="yes" />
        <!-- Allow upgrades and prevent downgrades -->
        <MajorUpgrade DowngradeErrorMessage="A later version of [ProductName] is already installed. Setup will now exit." />

        <!-- Define the directory structure -->
        <StandardDirectory Id="ProgramFiles6432Folder">
            <Directory Name="!(bind.Property.Manufacturer)">
                <Directory Id="INSTALLFOLDER" Name="!(bind.Property.ProductName)" />
            </Directory>
        </StandardDirectory>

        <!-- The files inside this DirectoryRef are linked to
			 the DlMirrorSync directory via INSTALLFOLDER -->
        <DirectoryRef Id="INSTALLFOLDER">
            <Component Id="HostEnv" Guid="d06d2c24-fc41-43ff-9675-3a4e29cd6437">
                <Environment Id="HostEnvVariable" Name="DlMirrorSync:MirrorHostUri" Value="[HOSTENVVARIABLE]" Part="all" Action="set" System="yes" />
            </Component>
            <!-- Create a single component which is the DlMirrorSync.exe file -->
            <Component Id="AppSettings">
                <File Id="appsettings.json" Source="..\publish\standalone\win-x64\appsettings.json" KeyPath="true" />
            </Component>
            <Component Id="ServiceExecutable" Bitness="always64">

                <!-- Copies the DlMirrorSync.exe file using the
					 project reference preprocessor variables -->
                <File Id="DlMirrorSync.exe" Source="..\publish\standalone\win-x64\DlMirrorSync.exe" KeyPath="true" />

                <!-- Remove all files from the INSTALLFOLDER on uninstall -->
                <RemoveFile Id="ALLFILES" Name="*.*" On="both" />

                <!-- Tell WiX to install the Service -->
                <ServiceInstall Id="ServiceInstaller" Type="ownProcess" Name="DlMirrorSync" DisplayName="$(Name)" Description="The Data Layer Mirror Sync Service watches for new chia data layer stores and subscribes to them." Start="auto" Account="LocalSystem" ErrorControl="normal" Arguments='"C:\Users\[USERNAME]\.chia\mainnet\config\config.yaml"'>
                </ServiceInstall>

                <!-- Tell WiX to start the Service -->
                <ServiceControl Id="StartService" Start="install" Stop="both" Remove="uninstall" Name="DlMirrorSync" Wait="true" />
            </Component>
        </DirectoryRef>

        <!-- Tell WiX to install the files -->
        <Feature Id="Service" Title="Data Layer Mirror Sync Service Setup" Level="1">
            <ComponentRef Id="ServiceExecutable" />
            <ComponentRef Id="AppSettings" />
            <ComponentRef Id="HostEnv" />
        </Feature>

    </Package>
</Wix>
